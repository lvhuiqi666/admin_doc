# 智慧水域-地图辅助工具

## 登录接口：

### 接口地址：v1/pc/map/login/

### 请求方式：POST

### 请求参数：

| 参数名 | 类型   | 是否必传 | 命名   | 备注 |
| ------ | ------ | -------- | ------ | ---- |
| mobile | STRING | 是       | 手机号 |      |
| pd     | STRING | 是       | 密码   |      |

### 请求示例:

```bash
{
    "mobile": "15180892716",
    "pd": "123456"
}
```

### 响应

#### 200

```bash
{
    "data": {
        "mobile": "13069634825", // 手机号
        "roles_name": "管理员", // 角色名称
        "id": 1,  // 用户ID
        "roles": 7,  // 角色ID
        "name": "吕品品"  // 用户名称
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 获取所有水域信息:

> 用于输出水域信息时，输入框匹配信息操作。

### 接口地址：v1/pc/map/all_waters/

### 请求方式：POST

### 请求参数：

* 

### 请求示例:

* 

### 响应

#### 200

```bash
{
    "data": [
    		{
        	"number": "ZJ-PY-RPTH", // 水域编号
        	"id": 92,  // 水域ID
       	  "name": "瑞平塘河"  // 水域名称
      },
   ]
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块一：获取所有水域对应点位信息名称:

> 用于输出点位信息时，输入框匹配信息操作。

### 接口地址：v1/pc/map/all_waters/

### 请求方式：POST

### 请求参数：

| 参数名   | 类型 | 是否必传 | 命名   | 备注                     |
| -------- | ---- | -------- | ------ | ------------------------ |
| watersId | INT  | 是       | 水域ID | 通过获取全部水域信息接口 |

### 请求示例:

```bash
{"watersId": 85}
```

### 响应

#### 200

```bash
{
    "data": {
        "wqResult": [ // 水下探测信息
            { 
                "id": 145,  // 探测ID
                "name": "疑似暗管" // 点位名称
            },
        ], 
        "wharf": [], // 水域码头信息
        "wqDetect": [ // 水质监测信息
            {
                "id": 92,  // 监测ID
                "name": "CD01" // 监测名称
            },
        ]
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块一：点位查询接口列表：

### 接口地址：v1/pc/map/query_water/points/

### 请求方式：POST

### 请求参数：

| 参数名     | 类型   | 是否必传 | 命名     | 备注         |
| ---------- | ------ | -------- | -------- | ------------ |
| watersName | STRING | 否       | 水域名称 | 支持模糊查询 |
| pointName  | STRING | 否       | 点位名称 | 支持模糊查询 |

### 请求示例:

```bash
{
    "watersName": "平宋",
    "pointName": "暗管"
}
```

### 响应

#### 200

```bash
{
    "data": {
        "wqResult": [  // 水下探测点位信息
            {
                "detect__waters__name": "平宋塘河",  // 水域名称
                "name": "疑似暗管", // 点位名称
                "number": "AG01", // 点位编号
                "lat": "27.75150863", // 纬度
                "lng": "120.5929729", // 经度
                "id": 145 // 点位ID
            },
        ],
        "wharf": [ // 水域码头信息
        		{
                "name": "上塘河",  // 码头名称
                "number": "", // 码头编号
                "device_type": 1,  // 码头类型:充电桩
                "statue": 1 , // 码头状态: 1在线、2离线、3故障
                "waters__name": "中塘河", // 水域名称
                "lat": "27.792930", // 纬度
                "lng": "120.685989", // 经度
                "id": 2  // 码头点位ID
            }
        ],
        "wqDetect": [ // 水质监测点信息
        		{
                "name": "疑似暗管01",  // 水质监测点名称
                "number": "08_132821", // 水质监测点编号
                "waters__name": "田螺峙河", //水域监测点水域信息
                "lat": "29.984287043", // 纬度
                "lng": "122.195286514", // 经度
                "id": 77 // 水质监测点ID
            },
       ]
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块一：更新码头点位信息：

### 接口地址：v1/pc/map/update/wharf_point/

### 请求方式：POST

### 请求参数：

| 参数名  | 类型   | 是否必传 | 命名   | 备注                            |
| ------- | ------ | -------- | ------ | ------------------------------- |
| wharfId | INT    | 是       | 码头ID | 根据查询点位信息返回的wharf字段 |
| lat     | STRING | 是       | 纬度   |                                 |
| lng     | STRING | 是       | 经度   |                                 |

### 请求示例:

```bash
{
    "wharfId": 29,
    "lat": "1",
    "lng": "1"
}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块一：更新水质监测点位信息：

### 接口地址：v1/pc/map/update/wq_detect_point/

### 请求方式：POST

### 请求参数：

| 参数名   | 类型   | 是否必传 | 命名         | 备注                               |
| -------- | ------ | -------- | ------------ | ---------------------------------- |
| detectId | INT    | 是       | 水质监测点ID | 根据查询点位信息返回的wqDetect字段 |
| lat      | STRING | 是       | 纬度         |                                    |
| lng      | STRING | 是       | 经度         |                                    |

### 请求示例:

```bash
{
    "detectId": 125,
    "lat": "1",
    "lng": "2"
}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块一：更新水下探测点位信息：

### 接口地址：v1/pc/map/update/wq_result_point/

### 请求方式：POST

### 请求参数：

| 参数名   | 类型   | 是否必传 | 命名           | 备注                               |
| -------- | ------ | -------- | -------------- | ---------------------------------- |
| resultId | INT    | 是       | 水下探测结果ID | 根据查询点位信息返回的wqResult字段 |
| lat      | STRING | 是       | 纬度           |                                    |
| lng      | STRING | 是       | 经度           |                                    |

### 请求示例:

```bash
{
    "resultId": 125,
    "lat": "1",
    "lng": "2"
}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块二：绘制轨迹接口：

> 入参trackList为空数组的时候，相当于是清空的操作，trackList里有数据的时候后端认为是新建/修改/增加同时操作。

### 接口地址：v1/pc/map/draw_track/

### 请求方式：POST

### 请求参数：

| 参数名    | 类型  | 是否必传 | 命名           | 备注                                         |
| --------- | ----- | -------- | -------------- | -------------------------------------------- |
| shipId    | INT   | 是       | 船舶ID         |                                              |
| ts        | FLOAT | 是       | 当天凌晨时间戳 | 秒级别                                       |
| trackList | LIST  | 否       | 轨迹点位       | 为空表示是清空操作、不为空表示有数据更新操作 |

### 请求示例:

```bash
{
    "shipId": 76,
    "ts": 1673625600,
    "trackList": [
        {
            "lng": "1111",
            "lat": "222"
        },
        {
            "lng": "33",
            "lat": "444"
        }
    ]
}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块二：查询轨迹信息：

> 查询轨迹信息，若当前船舶当前没有手动绘制轨迹时返回真实轨迹信息，如果当前船舶当天有手动绘制轨迹信息，那么返回新绘制的轨迹信息。注意：历史轨迹跟新轨迹返回的数据格式不同，需要区分。

### 接口地址：v1/pc/map/query_track/

### 请求方式：POST

### 请求参数：

| 参数名 | 类型  | 是否必传 | 命名           | 备注   |
| ------ | ----- | -------- | -------------- | ------ |
| shipId | INT   | 是       | 船舶ID         |        |
| ts     | FLOAT | 是       | 当天凌晨时间戳 | 秒级别 |

### 请求示例:

```bash
{
    "shipId": 77,
    "ts": 1673625600
}
```

### 响应

#### 200

**手动绘制新轨迹信息**：

```bash
{
    "data": {
    	  "type": 1, // 优化的轨迹(新轨迹)
        "new_data": [ // 以当前字段区分
            {		                
                "first_time": 1673652411, // 运行开始时间(从历史轨迹获取,跟大屏展示对齐)
                "last_time": 1673686556,  // 运行结束时间(从历史轨迹获取,跟大屏展示对齐)
                "ship_number": "0032", // 船舶编号
                "c_time": 1673703980774.0, // 创建时间
                "water_name": "环城河", // 水域信息
                "ship_name": "苏市水保5002", // 船名信息
                "detail": [ // 轨迹详情
                    {
                        "wgs84_lng": "1111", // 轨迹经度
                        "wgs84_lat": "222" // 轨迹纬度
                    },
                    {
                        "wgs84_lng": "33",
                        "wgs84_lat": "444"
                    },
                    {
                        "wgs84_lng": "55",
                        "wgs84_lat": "766"
                    }
                ],
                "ship_id": 77, // 船舶ID
                "_cls": "wisdom_waters_service.models.ShipTrack",
                "water_id": "78", // 水域ID
                "s_time": 1673625600, // 当天时间戳(秒级别)
                "_id": "63c2b22c07ebf326764553ce"
            }
        ]
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

**历史轨迹信息**：

```bash
{
    "data": {
        "type": 2, // 历史轨迹(老轨迹)
        "history_data": [ // 以当前字段进行区分老轨迹
            {
                "ship": { // 船舶信息
                    "id": 78, // 船舶ID
                    "name": "苏市水保5001" // 船舶名称
                },
                "_id": "63c26d67ad05290089609788",
                "wgs84_lng": "120.604705811", // 轨迹经度
                "wgs84_lat": "31.3285007477", // 轨迹纬度
                "s_time": 1673686373 // 轨迹创建时间
            },        ]
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块二：轨迹优化接口：

> 当前功能，后端无法做校验，需要客户端进行配合，找到当前轨迹中哪个点位是漂移很远的点位，然后将ID传递给后端进行删除。轨迹优化功能仅对历史轨迹生效，手动绘制的轨迹无需操作。

### 接口地址：v1/pc/map/delete_track/

### 请求方式：POST

### 请求参数：

| 参数名     | 类型   | 是否必传 | 命名             | 备注 |
| ---------- | ------ | -------- | ---------------- | ---- |
| historyIds | STRING | 是       | 返回历史轨迹的ID |      |

### 请求示例:

```bash
{"historyIds": ["63c26e1ead0529008d609967"]}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块二：轨迹复位功能接口：

### 接口地址：v1/pc/map/reset_track/

### 请求方式：POST

### 请求参数：

| 参数名 | 类型  | 是否必传 | 命名           | 备注   |
| ------ | ----- | -------- | -------------- | ------ |
| shipId | INT   | 是       | 船舶ID         |        |
| ts     | FLOAT | 是       | 当天凌晨时间戳 | 秒级别 |

### 请求示例:

```bash
{
    "shipId": 77,
    "ts": 1673625600
}
```

### 响应

#### 200

```bash
{
    "data": {
      {
      "ship": { // 船舶信息
      "id": 78, // 船舶ID
      "name": "苏市水保5001" // 船舶名称
      },
      "_id": "63c26d67ad05290089609788",
      "wgs84_lng": "120.604705811", // 轨迹经度
      "wgs84_lat": "31.3285007477", // 轨迹纬度
      "s_time": 1673686373 // 轨迹创建时间
      },
    },
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 获取所有船舶信息接口：

> 用在轨迹优化列表页，根据船舶名称进行筛选时使用，名称匹配上以后，查询接口将船舶ID进行传递。

### 接口地址：v1/pc/map/all_ship/

### 请求方式：POST

### 请求参数：

* 

### 请求示例:

* 

### 响应

#### 200

```bash
{
    "data": [
        {
            "number": "0033", // 船舶编号
            "id": 78, // 船舶ID
            "name": "苏市水保5001" // 船舶名称
        },
    ],
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块三：绘制定点/动态水质热力图轨迹接口：

> 入参trackList为空数组的时候，相当于是清空的操作，trackList里有数据的时候后端认为是新建/修改/增加同时操作。

### 接口地址：v1/pc/map/draw_water_quality_track/

### 请求方式：POST

### 请求参数：

| 参数名    | 类型  | 是否必传 | 命名           | 备注                                         |
| --------- | ----- | -------- | -------------- | -------------------------------------------- |
| shipId    | INT   | 是       | 船舶ID         |                                              |
| ts        | FLOAT | 是       | 当天凌晨时间戳 | 秒级别                                       |
| trackList | LIST  | 否       | 轨迹点位       | 为空表示是清空操作、不为空表示有数据更新操作 |
| type      | INT   | 是       | 类别           | 1:表示定点轨迹、2:表示动态轨迹               |

### 请求示例:

```bash
{
    "shipId": 76,
    "ts": 1673625600,
    "type": 1,
    "trackList": [
        {
            "lng": "1111",
            "lat": "222"
        },
        {
            "lng": "33",
            "lat": "444"
        }
    ]
}
```

### 响应

#### 200

```bash
{
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块三：加载定点/动态检测点位数据接口

> 切换到板块三的时候，加载当前接口，返回当前日期，当前船舶监测的定点/动态水质点位信息接口，提供给热力图轨迹做参考。
>
> **注意**：定点监测/动态监测返回的数据结构不同。

### 接口地址：v1//pc/map/water_quality_point/

### 请求方式：POST

### 请求参数：

| 参数名 | 类型  | 是否必传 | 命名           | 备注                                         |
| ------ | ----- | -------- | -------------- | -------------------------------------------- |
| shipId | INT   | 是       | 船舶ID         |                                              |
| ts     | FLOAT | 是       | 当天凌晨时间戳 | 秒级别                                       |
| type   | INT   | 是       | 类别           | 1:表示获取监测定点位、2:表示获取动态河段点位 |

### 请求示例:

```bash
{
    "shipId": 75,
    "type": 1,
    "ts": 1669478400
}
```

### 响应

#### 200

**type=1的时候定点监测返回的数据结构**

```bash
{
    "data": [
        {
            "wq_ts": "1669478400", // 当天水质日期
            "water_quality__name": "定点03",  // 水质名称
            "water_quality__number": "DD03",  // 水质编码
            "lat": "30.1605695",  // 纬度
            "lng": "120.0801864", // 经度 
            "id": 376  
        },
        {
            "wq_ts": "1669478400",
            "water_quality__name": "暗管06",
            "water_quality__number": "AG06",
            "lat": "30.1672546",
            "lng": "120.0859337",
            "id": 385
        },
    ],
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

**type=2的时候动态监测返回的数据结构**

```bash
{
    "data": [
        {
            "ship": { // 船舶信息
                "id": 75,  // 船舶编号
                "name": "QDF-0030" //船舶名称
            },
            "_id": "6390aa91a541dd1a79a0f07d",
            "wgs84_lng": "119.0282084",  // 经度
            "wgs84_lat": "29.6348461", // 纬度
            "s_time": 1669450230  // 水质信息
        },
        {
            "ship": {
                "id": 75,
                "name": "QDF-0030"
            },
            "_id": "6390aa90a541dd1a79a0f073",
            "wgs84_lng": "119.0143609",
            "wgs84_lat": "29.6416945",
            "s_time": 1669447850
        },
    ],
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

## 板块三：查询定点/动态检测点位数据接口

> 刚进入板块三的时候，需要调用两个接口，一个是【加载定点/动态监测点位数据接口】，一个是当前的接口，相当于轨迹跟点位信息是两个接口返回数据进行加载，如果当前船舶没有手动绘制热力图，那么就返回空数组。

### 接口地址：v1/pc/map/query_water_quality_track/

### 请求方式：POST

### 请求参数：

| 参数名 | 类型  | 是否必传 | 命名           | 备注                                         |
| ------ | ----- | -------- | -------------- | -------------------------------------------- |
| shipId | INT   | 是       | 船舶ID         |                                              |
| ts     | FLOAT | 是       | 当天凌晨时间戳 | 秒级别                                       |
| type   | INT   | 是       | 类别           | 1:表示获取监测定点位、2:表示获取动态河段点位 |

### 请求示例:

```bash
{
    "shipId": 76,
    "type": 1,
    "ts": 1673625600
}
```

### 响应

#### 200

```bash
{
    "data": [
        {
            "ship_number": "0031",  // 船舶编号
            "c_time": 1674384362051.0, // 创建时间 
            "water_name": "外塘河",// 水域名称
            "ship_name": "苏市水保5003", // 船舶名称
            "detail": [  // 详情轨迹信息
                {
                    "wgs84_lng": "1111",
                    "wgs84_lat": "222"
                },
                {
                    "wgs84_lng": "33",
                    "wgs84_lat": "444"
                }
            ],
            "ship_id": 76,  // 船舶ID
            "_cls": "wisdom_waters_service.models.ShipWaterQualityTrack",
            "water_id": "79", // 水域ID
            "s_time": 1673625600,  // 当前时间戳
            "_id": "63cd13ea07ebf34a49522ce1",
            "type": 1 // 类别：1 表示是定点监测点位、2 表示是动态监测水质点位
        }
    ],
    "retCode": 0,
    "retMsg": "成功 | Success"
}
```

